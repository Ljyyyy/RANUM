# Readme: RANUM

RANUM is a tool for testing and debugging the numerical failures in DNN architectures.

## Usage

All scripts run on Python 3.6.9 + PyTorch 1.8.1 with CPU environment. GPU support only requires minor changes in the code (place `tensor.cuda()` at necessary places).
For following commands, the working directory is the root directory of this project.
All results are output to `results/` folder.

## Result Reproduction

1. To generate all tables presented in the manuscript from included execution logs, please execute:

```
~/anaconda3/bin/ipython evaluate/texify/final_texify.py
```

Data in all experiment tables from the manuscript are automatically generated from the above command.

2.

To evaluate the RANUM and other baseline approaches from scratch, we create a few scripts to run all GRIST dataset cases for 10 random seeds with one command.
You can use the following script to obtain all results. **It takes roughly 2 days.**

```
~/anaconda3/bin/ipython evaluate/bug_verifier.py

~/anaconda3/bin/ipython evaluate/precond_generator.py debarus all
~/anaconda3/bin/ipython evaluate/precond_generator.py debarus weight
~/anaconda3/bin/ipython evaluate/precond_generator.py debarus input
~/anaconda3/bin/ipython evaluate/precond_generator.py gd all
~/anaconda3/bin/ipython evaluate/precond_generator.py gd weight
~/anaconda3/bin/ipython evaluate/precond_generator.py gd input
~/anaconda3/bin/ipython evaluate/precond_generator.py debarusexpand all
~/anaconda3/bin/ipython evaluate/precond_generator.py debarusexpand weight
~/anaconda3/bin/ipython evaluate/precond_generator.py debarusexpand input

~/anaconda3/bin/ipython evaluate/robust_inducing_inst_generator.py
~/anaconda3/bin/ipython experiments/unittest/onestep_gd.py

~/anaconda3/bin/ipython experiments/unittest/err_trigger.py debarus
~/anaconda3/bin/ipython experiments/unittest/err_trigger.py gd
~/anaconda3/bin/ipython experiments/unittest/err_trigger.py random

~/anaconda3/bin/ipython evaluate/train_inst_generator.py debarus
~/anaconda3/bin/ipython evaluate/train_inst_generator.py random
~/anaconda3/bin/ipython evaluate/train_inst_generator.py debarus_p_random
~/anaconda3/bin/ipython evaluate/train_inst_generator.py random_p_debarus

```


#### 3. Empirical Study

The detail empirical study log (along with the repository URLs) is in `empirical_study/precond/study_detail.txt` and the statistics are in `empirical_study/precond/study_statistics.csv`.
The human-friendly precondition-fixes generated by RANUM are in `empirical_study/precond`.

The list of DEBAR supported DNN operator types is in `empirical_study/debar_abstraction_list.txt`.
The list of RANUM supported DNN operator types can be counted from `interp/interp_operator.py`(`inter_*` methods in `Interpreter` class).

## Commands for Individual Tasks

Specifically, we show the individual commands for each stage task.

### 0. Static Defect Detection

RANUM: `python3 evaluate/bug_verifier.py`

The running results of DEBAR are from GRIST (Yan et al) paper and DEBAR (Zhang et al) repository.

### 1. Unit Test Generation

#### RANUM
    
1. `python3 evaluate/robust_inducing_inst_generator.py` - generate failure-inducing intervals
2. `python3 experiments/unittest/err_trigger.py debarus` - generate 1000 distinct unit tests from these intervals

#### Gradient Descent
    
1. `python3 experiments/unittest/onestep_gd.py` - generate failure-inducing intervals
2. `python3 experiments/unittest/err_trigger.py gd` - generate 1000 distinct unit tests from these intervals
    
##### Random
    
`python3 experiments/unittest/err_trigger.py random` - generate 1000 distinct unit tests from these intervals

### 2. System Test Generation

System test generation relies on the generated unit tests, so please run unit test generation first


#### RANUM

`python3 evaluate/train_inst_generator.py debarus`

#### Random

`python3 evaluate/train_inst_generator.py random`

#### RANUM for inference + Random for system

`python3 evaluate/train_inst_generator.py debarus_p_random`

#### Random for inference + RANUM for system

`python3 evaluate/train_inst_generator.py random_p_debarus`

### 3. Precondition-Fix Generation

#### a. Precondition on Weight + Input Nodes

##### RANUM

`python3 evaluate/precond_generator.py debarus all`

##### RANUM Expand

`python3 evaluate/precond_generator.py debarusexpand all`

##### Gradient Descent

`python3 evaluate/precond_generator.py gd all`

#### b. Precondition on Weight Nodes

##### RANUM

`python3 evaluate/precond_generator.py debarus weight`

##### RANUM Expand (RANUM-E)

`python3 evaluate/precond_generator.py debarusexpand weight`

##### Gradient Descent

`python3 evaluate/precond_generator.py gd weight`

#### c. Precondition on Input Nodes

##### RANUM

`python3 evaluate/precond_generator.py debarus input`

##### RANUM Expand (RANUM-E)

`python3 evaluate/precond_generator.py debarusexpand input`

##### Gradient Descent

`python3 evaluate/precond_generator.py gd input`

